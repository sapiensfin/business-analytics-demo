import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Business Architect: What-If Analysis", layout="wide")

# --- 1. –ü–û–í–ù–Ü –î–ê–ù–Ü –ù–ê 6 –ú–Ü–°–Ø–¶–Ü–í ---
def get_base_data():
    data = []
    months = ['2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06']
    for m in months:
        # –í–∏—Ç—Ä–∞—Ç–∏
        data.append({'–î–∞—Ç–∞': f'{m}-10', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 50000})
        data.append({'–î–∞—Ç–∞': f'{m}-15', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ (—É—Å—ñ)', '–°—É–º–∞': 280000})
        data.append({'–î–∞—Ç–∞': f'{m}-20', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 85000})
        
        # –ú–æ–¥–µ–ª—é—î–º–æ –∫—Ä–∏–∑—É –≤ –±–µ—Ä–µ–∑–Ω—ñ
        if m == '2025-03':
            data.append({'–î–∞—Ç–∞': f'{m}-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ù–∞ —Ä–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 150000})
            data.append({'–î–∞—Ç–∞': f'{m}-12', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞–≤—Ç–æ–ø–∞—Ä–∫—É', '–°—É–º–∞': 120000})
        else:
            data.append({'–î–∞—Ç–∞': f'{m}-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ù–∞ —Ä–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 420000})
            data.append({'–î–∞—Ç–∞': f'{m}-07', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ì–æ—Ç—ñ–≤–∫–∞', '–°—É–º–∞': 100000})
    return pd.DataFrame(data)

# --- 2. WHAT-IF –ü–ê–†–ê–ú–ï–¢–†–ò (–°–ò–ú–£–õ–Ø–¢–û–†) ---
st.sidebar.header("üïπÔ∏è –°–∏–º—É–ª—è—Ç–æ—Ä —Ä—ñ—à–µ–Ω—å (What-If)")
st.sidebar.markdown("–ó–º—ñ–Ω—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏, —è–∫ —Ü–µ –≤–ø–ª–∏–Ω–µ –Ω–∞ –∫–∞—Å–æ–≤–∏–π —Ä–æ–∑—Ä–∏–≤:")

inc_change = st.sidebar.slider("–ó–º—ñ–Ω–∞ –¥–æ—Ö–æ–¥—ñ–≤ (–¶—ñ–Ω–∏/–ü—Ä–æ–¥–∞–∂—ñ), %", -20, 50, 0)
exp_change = st.sidebar.slider("–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –≤–∏—Ç—Ä–∞—Ç, %", -30, 0, 0)
init_bal = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ (PLN)", value=120000)

# --- 3. –û–ë–†–û–ë–ö–ê –î–ê–ù–ò–• –ó –£–†–ê–•–£–í–ê–ù–ù–Ø–ú –°–ò–ú–£–õ–Ø–¶–Ü–á ---
df = get_base_data()
df['–°—É–º–∞'] = pd.to_numeric(df['–°—É–º–∞'])

# –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∑–º—ñ–Ω–∏ –≤—ñ–¥ –ø–æ–≤–∑—É–Ω–∫—ñ–≤
df.loc[df['–¢–∏–ø'] == '1. –ü–†–ò–•–û–î–ò', '–°—É–º–∞'] *= (1 + inc_change / 100)
df.loc[df['–¢–∏–ø'] == '2. –í–ò–¢–†–ê–¢–ò', '–°—É–º–∞'] *= (1 + exp_change / 100)

df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df['–ú—ñ—Å—è—Ü—å'] = df['–î–∞—Ç–∞'].dt.strftime('%Y-%m')

# --- 4. –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø P&L ---
st.title("üèÜ Financial Strategy Simulator 2025")
st.subheader("üìë –ü—Ä–æ–≥–Ω–æ–∑–Ω–∏–π P&L –∑–≤—ñ—Ç (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Å–∏–º—É–ª—è—Ü—ñ—ó)")

pnl_pivot = df.pivot_table(index=['–¢–∏–ø', '–°—Ç–∞—Ç—Ç—è'], columns='–ú—ñ—Å—è—Ü—å', values='–°—É–º–∞', aggfunc='sum', fill_value=0)
st.dataframe(pnl_pivot.style.format("{:,.0f}").background_gradient(cmap='RdYlGn', axis=1), use_container_width=True)

# --- 5. –ì–†–ê–§–Ü–ö CASH FLOW (–î–ò–ù–ê–ú–Ü–ß–ù–ò–ô) ---
st.divider()
st.subheader("üìâ –ü—Ä–æ–≥–Ω–æ–∑ Cash Flow")

df = df.sort_values('–î–∞—Ç–∞')
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if '–ü–†–ò–•–û–î–ò' in x['–¢–∏–ø'] else -x['Su–º–∞'], axis=1) # –¢—É—Ç –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –°—É–º–∞
# –£—Ç–æ—á–Ω–µ–Ω–Ω—è: —á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É –≤ –Ω–∞–∑–≤—ñ –≤–∏—â–µ, –≤–∏–ø—Ä–∞–≤–ª—è—î–º–æ —Ä—è–¥–æ–∫:
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if '–ü–†–ò–•–û–î–ò' in x['–¢–∏–ø'] else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

fig = go.Figure()
fig.add_trace(go.Scatter(x=df['–î–∞—Ç–∞'], y=df['–ó–∞–ª–∏—à–æ–∫'], mode='lines+markers', fill='tozeroy', 
                         name='–ü—Ä–æ–≥–Ω–æ–∑ –±–∞–ª–∞–Ω—Å—É', line=dict(color='#00CC96', width=4)))
fig.add_hline(y=0, line_dash="dash", line_color="#FF4B4B", line_width=2)

# –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–æ–Ω–∏ —Ä–æ–∑—Ä–∏–≤—É –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
min_bal = df['–ó–∞–ª–∏—à–æ–∫'].min()
if min_bal < 0:
    fig.add_hrect(y0=min_bal-10000, y1=0, fillcolor="red", opacity=0.1, annotation_text="–ó–û–ù–ê –†–û–ó–†–ò–í–£")

fig.update_layout(height=500, margin=dict(l=20, r=20, t=30, b=20))
st.plotly_chart(fig, use_container_width=True)

# --- 6. –í–ò–°–ù–û–í–û–ö –°–ò–ú–£–õ–Ø–¶–Ü–á ---
if min_bal < 0:
    st.error(f"‚ùå **–ü—Ä–∏ —Ç–∞–∫–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö:** –ö–∞—Å–æ–≤–∏–π —Ä–æ–∑—Ä–∏–≤ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è. –î–µ—Ñ—ñ—Ü–∏—Ç: **{abs(min_bal):,.0f} PLN**.")
    st.write("üëâ –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ –∑–Ω–∏–∑–∏—Ç–∏ –≤–∏—Ç—Ä–∞—Ç–∏ –∞–±–æ –∑–±—ñ–ª—å—à–∏—Ç–∏ –¥–æ—Ö—ñ–¥ —É —Å–∏–º—É–ª—è—Ç–æ—Ä—ñ.")
else:
    st.success(f"‚úÖ **–†—ñ—à–µ–Ω–Ω—è —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ!** –ö–∞—Å–æ–≤–∏–π —Ä–æ–∑—Ä–∏–≤ –ø–æ–¥–æ–ª–∞–Ω–æ. –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫ —Å–∫–ª–∞–¥–µ **{min_bal:,.0f} PLN**.")
