import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Strategic Business Simulator 2025", layout="wide")

# --- 1. –ü–û–í–ù–Ü –î–ê–ù–Ü –ù–ê 6 –ú–Ü–°–Ø–¶–Ü–í ---
def get_base_data():
    data = []
    months = ['2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06']
    for m in months:
        # –ü–æ—Å—Ç—ñ–π–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏
        data.append({'–î–∞—Ç–∞': f'{m}-10', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 50000})
        data.append({'–î–∞—Ç–∞': f'{m}-15', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ (—É—Å—ñ)', '–°—É–º–∞': 280000})
        data.append({'–î–∞—Ç–∞': f'{m}-20', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 85000})
        data.append({'–î–∞—Ç–∞': f'{m}-25', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–æ–¥–∞—Ç–∫–∏ —Ç–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è', '–°—É–º–∞': 50000})
        
        # –ú–æ–¥–µ–ª—é—î–º–æ –∫—Ä–∏–∑—É –≤ –±–µ—Ä–µ–∑–Ω—ñ
        if m == '2025-03':
            data.append({'–î–∞—Ç–∞': f'{m}-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ù–∞ —Ä–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 150000})
            data.append({'–î–∞—Ç–∞': f'{m}-12', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞–≤—Ç–æ–ø–∞—Ä–∫—É', '–°—É–º–∞': 130000})
        else:
            data.append({'–î–∞—Ç–∞': f'{m}-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ù–∞ —Ä–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 420000})
            data.append({'–î–∞—Ç–∞': f'{m}-07', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ì–æ—Ç—ñ–≤–∫–∞', '–°—É–º–∞': 100000})
    return pd.DataFrame(data)

# --- 2. WHAT-IF –ü–ê–†–ê–ú–ï–¢–†–ò –í –ë–Ü–ß–ù–Ü–ô –ü–ê–ù–ï–õ–Ü ---
st.sidebar.header("üïπÔ∏è –°–∏–º—É–ª—è—Ç–æ—Ä —Ä—ñ—à–µ–Ω—å")
st.sidebar.markdown("–Ø–∫ –∑–º—ñ–Ω—è—Ç—å—Å—è —Ü–∏—Ñ—Ä–∏, —è–∫—â–æ –º–∏:")

inc_change = st.sidebar.slider("–ó–º—ñ–Ω–∏–º–æ –¥–æ—Ö—ñ–¥ (–¶—ñ–Ω–∏/–ü—Ä–æ–¥–∞–∂—ñ), %", -30, 50, 0)
exp_change = st.sidebar.slider("–û–ø—Ç–∏–º—ñ–∑—É—î–º–æ –≤–∏—Ç—Ä–∞—Ç–∏, %", -40, 0, 0)
init_bal = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ –Ω–∞ 01.01 (PLN)", value=120000)

# --- 3. –û–ë–†–û–ë–ö–ê –î–ê–ù–ò–• –ó –£–†–ê–•–£–í–ê–ù–ù–Ø–ú –°–ò–ú–£–õ–Ø–¶–Ü–á ---
df = get_base_data()
df['–°—É–º–∞'] = pd.to_numeric(df['–°—É–º–∞'], errors='coerce').fillna(0)

# –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ –≤—ñ–¥ –ø–æ–≤–∑—É–Ω–∫—ñ–≤
df.loc[df['–¢–∏–ø'] == '1. –ü–†–ò–•–û–î–ò', '–°—É–º–∞'] *= (1 + inc_change / 100)
df.loc[df['–¢–∏–ø'] == '2. –í–ò–¢–†–ê–¢–ò', '–°—É–º–∞'] *= (1 + exp_change / 100)

df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df['–ú—ñ—Å—è—Ü—å'] = df['–î–∞—Ç–∞'].dt.strftime('%Y-%m')

# --- 4. –ì–û–õ–û–í–ù–ò–ô –ï–ö–†–ê–ù: P&L ---
st.title("üèÜ Financial Strategy Simulator 2025")
st.markdown("### –ê–Ω–∞–ª—ñ–∑ –ø—Ä–∏–±—É—Ç–∫–æ–≤–æ—Å—Ç—ñ —Ç–∞ –∫–∞—Å–æ–≤–∏—Ö —Ä–æ–∑—Ä–∏–≤—ñ–≤ –Ω–∞ 6 –º—ñ—Å—è—Ü—ñ–≤")

pnl_pivot = df.pivot_table(index=['–¢–∏–ø', '–°—Ç–∞—Ç—Ç—è'], columns='–ú—ñ—Å—è—Ü—å', values='–°—É–º–∞', aggfunc='sum', fill_value=0)
pnl_pivot['–†–ê–ó–û–ú'] = pnl_pivot.sum(axis=1)

st.dataframe(
    pnl_pivot.style.format("{:,.0f}")
    .background_gradient(cmap='Greens', subset=pd.IndexSlice[('1. –ü–†–ò–•–û–î–ò', slice(None)), :])
    .background_gradient(cmap='Reds', subset=pd.IndexSlice[('2. –í–ò–¢–†–ê–¢–ò', slice(None)), :]),
    use_container_width=True
)

# --- 5. –†–û–ó–†–ê–•–£–ù–û–ö –¢–ê –ì–†–ê–§–Ü–ö CASH FLOW ---
st.divider()
st.subheader("üìâ –ù–∞–æ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ Cash Flow (–∑–∞–ª–∏—à–æ–∫ –≥—Ä–æ—à–µ–π)")

df = df.sort_values('–î–∞—Ç–∞')
# –¢–£–¢ –ü–û–í–ù–Ü–°–¢–Æ –í–ò–ü–†–ê–í–õ–ï–ù–û –ù–ê–ó–í–ò –ö–û–õ–û–ù–û–ö (—Ç—ñ–ª—å–∫–∏ –∫–∏—Ä–∏–ª–∏—Ü—è –≤ '–°—É–º–∞')
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if '–ü–†–ò–•–û–î–ò' in x['–¢–∏–ø'] else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

fig = go.Figure()
fig.add_trace(go.Scatter(
    x=df['–î–∞—Ç–∞'], y=df['–ó–∞–ª–∏—à–æ–∫'], 
    mode='lines+markers', fill='tozeroy', 
    name='–ë–∞–ª–∞–Ω—Å', line=dict(color='#00CC96', width=4)
))

# –õ—ñ–Ω—ñ—è —Ä–æ–∑—Ä–∏–≤—É
fig.add_hline(y=0, line_dash="dash", line_color="#FF4B4B", line_width=2)

min_bal = df['–ó–∞–ª–∏—à–æ–∫'].min()
if min_bal < 0:
    fig.add_hrect(y0=min_bal-20000, y1=0, fillcolor="red", opacity=0.1, annotation_text="–î–ï–§–Ü–¶–ò–¢ –ö–û–®–¢–Ü–í")

fig.update_layout(xaxis_title="–°—ñ—á–µ–Ω—å - –ß–µ—Ä–≤–µ–Ω—å 2025", yaxis_title="–ó–∞–ª–∏—à–æ–∫ (PLN)", height=500)
st.plotly_chart(fig, use_container_width=True)

# --- 6. –í–ò–°–ù–û–í–ö–ò –î–õ–Ø –í–õ–ê–°–ù–ò–ö–ê ---
c1, c2 = st.columns(2)
with c1:
    if min_bal < 0:
        st.error(f"üö® **–£–≤–∞–≥–∞:** –ü—Ä–æ–≥–Ω–æ–∑—É—î—Ç—å—Å—è –∫–∞—Å–æ–≤–∏–π —Ä–æ–∑—Ä–∏–≤. –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å: **{min_bal:,.0f} PLN**.")
    else:
        st.success(f"‚úÖ **–°—Ç–∞–±—ñ–ª—å–Ω–æ:** –ó–∞–ª–∏—à–æ–∫ –Ω–µ –ø–∞–¥–∞—î –Ω–∏–∂—á–µ –Ω—É–ª—è. –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å: **{min_bal:,.0f} PLN**.")

with c2:
    total_profit = df[df['–¢–∏–ø'] == '1. –ü–†–ò–•–û–î–ò']['–°—É–º–∞'].sum() - df[df['–¢–∏–ø'] == '2. –í–ò–¢–†–ê–¢–ò']['–°—É–º–∞'].sum()
    st.metric("–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ –∑–∞ 6 –º—ñ—Å.", f"{total_profit:,.0f} PLN")

# –ö–Ω–æ–ø–∫–∞ –¥–ª—è —à–∞–±–ª–æ–Ω—É
csv = df[['–î–∞—Ç–∞', '–¢–∏–ø', '–°—Ç–∞—Ç—Ç—è', '–°—É–º–∞']].to_csv(index=False).encode('utf-8-sig')
st.sidebar.download_button("üì• –°–∫–∞—á–∞—Ç–∏ —à–∞–±–ª–æ–Ω (CSV)", data=csv, file_name='strategy_2025.csv')
