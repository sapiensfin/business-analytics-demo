import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Business Architect: P&L & CashFlow", layout="wide")

# --- 1. –ì–ï–ù–ï–†–ê–¶–Ü–Ø –î–ï–ú–û-–î–ê–ù–ò–• (2025 –†–Ü–ö) ---
def get_demo_data():
    data = [
        # –§–∞–∫—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–û–ø–ª–∞—Ç–∞ –ö–ª—ñ—î–Ω—Ç –ê', '–°—É–º–∞': 250000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-15', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 60000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∏ –æ—Ñ—ñ—Å/—Å–∫–ª–∞–¥', '–°—É–º–∞': 120000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        
        # –ü–ª–∞–Ω–æ–≤—ñ –¥–∞–Ω—ñ (–ë–µ—Ä–µ–∑–µ–Ω—å - –º–æ–∂–ª–∏–≤–∏–π —Ä–æ–∑—Ä–∏–≤)
        {'–î–∞—Ç–∞': '2025-02-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–°–∫–ª–∞–¥', '–°—Ç–∞—Ç—Ç—è': '–ö–æ–Ω—Ç—Ä–∞–∫—Ç ‚Ññ22', '–°—É–º–∞': 150000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-25', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞–≤—Ç–æ', '–°—É–º–∞': 35000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-03-01', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–§—ñ–Ω–∞–Ω—Å–∏', '–°—Ç–∞—Ç—Ç—è': '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫—Ä–µ–¥–∏—Ç—É', '–°—É–º–∞': 100000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-03-15', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–î–µ–±—ñ—Ç–æ—Ä–∫–∞ –ë', '–°—É–º–∞': 280000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'}
    ]
    return pd.DataFrame(data)

# --- 2. –Ü–ù–¢–ï–†–§–ï–ô–° –¢–ê –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
st.title("üíº Business Intelligence: P&L + Cash Flow")
st.sidebar.header("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")

# –ö–Ω–æ–ø–∫–∞ —à–∞–±–ª–æ–Ω—É
demo_df = get_demo_data()
csv_template = demo_df.to_csv(index=False).encode('utf-8-sig')
st.sidebar.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω CSV", data=csv_template, file_name='finance_template.csv', mime='text/csv')

uploaded_file = st.sidebar.file_uploader("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à —Ñ–∞–π–ª", type=['csv', 'xlsx'])
init_bal = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ (PLN)", value=80000)

if uploaded_file:
    df = pd.read_excel(uploaded_file) if uploaded_file.name.endswith('.xlsx') else pd.read_csv(uploaded_file)
else:
    df = demo_df
    st.info("üí° –ü–æ–∫–∞–∑–∞–Ω–æ –¥–µ–º–æ-–¥–∞–Ω—ñ. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤—ñ–π —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É.")

# –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df = df.sort_values('–î–∞—Ç–∞')
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if x['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥' else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

# --- 3. –ë–õ–û–ö 1: –§–Ü–ù–ê–ù–°–û–í–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢ (P&L) ---
st.subheader("üìà –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (P&L)")
total_inc = df[df['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥']['–°—É–º–∞'].sum()
total_exp = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞']['–°—É–º–∞'].sum()
net_profit = total_inc - total_exp
rent = (net_profit / total_inc * 100) if total_inc > 0 else 0

c1, c2, c3 = st.columns(3)
c1.metric("–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥", f"{total_inc:,.0f} PLN")
c2.metric("–ó–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏", f"{total_exp:,.0f} PLN", delta=f"-{total_exp:,.0f}", delta_color="inverse")
c3.metric("–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫", f"{net_profit:,.0f} PLN", delta=f"{rent:.1f}% –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å")

# –ì—Ä–∞—Ñ—ñ–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤–∏—Ç—Ä–∞—Ç –ø–æ –Ω–∞–ø—Ä—è–º–∫–∞—Ö
exp_df = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞'].groupby('–ù–∞–ø—Ä—è–º–æ–∫')['–°—É–º–∞'].sum().reset_index()
fig_pie = px.pie(exp_df, values='–°—É–º–∞', names='–ù–∞–ø—Ä—è–º–æ–∫', hole=0.4, title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç –ø–æ –Ω–∞–ø—Ä—è–º–∫–∞—Ö")
st.plotly_chart(fig_pie, use_container_width=True)

st.divider()

# --- 4. –ë–õ–û–ö 2: –ö–ï–®–§–õ–û–£ –¢–ê –†–û–ó–†–ò–í–ò ---
st.subheader("üìâ –ü—Ä–æ–≥–Ω–æ–∑ Cash Flow (–ö–∞—Å–æ–≤—ñ —Ä–æ–∑—Ä–∏–≤–∏)")

fig_cf = go.Figure()
fig_cf.add_trace(go.Scatter(x=df['–î–∞—Ç–∞'], y=df['–ó–∞il—à–æ–∫'], mode='lines+markers', name='–ó–∞–ª–∏—à–æ–∫', line=dict(color='#00CC96', width=3)))
fig_cf.add_hline(y=0, line_dash="dash", line_color="red")
fig_cf.add_hrect(y0=-500000, y1=0, fillcolor="red", opacity=0.1, annotation_text="–ö–†–ò–¢–ò–ß–ù–ê –ó–û–ù–ê")

st.plotly_chart(fig_cf, use_container_width=True)

# –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —Ä–æ–∑—Ä–∏–≤
gaps = df[df['–ó–∞–ª–∏—à–æ–∫'] < 0]
if not gaps.empty:
    st.error(f"‚ö†Ô∏è –í–∏—è–≤–ª–µ–Ω–æ —Ä–∏–∑–∏–∫ –∫–∞—Å–æ–≤–æ–≥–æ —Ä–æ–∑—Ä–∏–≤—É {gaps.iloc[0]['–î–∞—Ç–∞'].strftime('%d-%m-%Y')}!")
else:
    st.success("‚úÖ –ì—Ä–æ—à–µ–π –≤–∏—Å—Ç–∞—á–∞—î –¥–ª—è –ø–æ–∫—Ä–∏—Ç—Ç—è –≤—Å—ñ—Ö –ø–ª–∞–Ω–æ–≤–∏—Ö –≤–∏—Ç—Ä–∞—Ç.")

# –î–µ—Ç–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è
if st.checkbox("–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤–Ω—É —Ç–∞–±–ª–∏—Ü—é –æ–ø–µ—Ä–∞—Ü—ñ–π"):
    st.write(df[['–î–∞—Ç–∞', '–¢–∏–ø', '–ù–∞–ø—Ä—è–º–æ–∫', '–°—Ç–∞—Ç—Ç—è', '–°—É–º–∞', '–°—Ç–∞—Ç—É—Å', '–ó–∞–ª–∏—à–æ–∫']])
