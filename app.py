import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Business Architect: Full P&L Report", layout="wide")

# --- 1. –ü–û–í–ù–Ü –î–ï–ú–û-–î–ê–ù–Ü ---
def get_demo_data():
    data = [
        # –°–Ü–ß–ï–ù–¨ 2025
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ì–æ—Ç—ñ–≤–∫–∞', '–°—É–º–∞': 120000},
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ù–∞ —Ä–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 450000},
        {'–î–∞—Ç–∞': '2025-01-10', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞', '–°—É–º–∞': 50000},
        {'–î–∞—Ç–∞': '2025-01-15', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –æ—Ñ—ñ—Å', '–°—É–º–∞': 60000},
        {'–î–∞—Ç–∞': '2025-01-15', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥', 'Su–º–∞': 90000}, # –¢—É—Ç –±—É–ª–∞ –ø–æ–º–∏–ª–∫–∞ –≤ –Ω–∞–∑–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ —Ä–∞–Ω—ñ—à–µ
        {'–î–∞—Ç–∞': '2025-01-15', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–¥—ñ—ó', '–°—É–º–∞': 150000},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 85000},
        {'–î–∞—Ç–∞': '2025-01-22', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞/–º', '–°—É–º–∞': 15000},
        {'–î–∞—Ç–∞': '2025-01-25', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–æ—Å–ª—É–≥–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—ó', '–°—É–º–∞': 5000},
        {'–î–∞—Ç–∞': '2025-01-28', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–æ–¥–∞—Ç–∫–∏ –Ω–∞ –∑/–ø', '–°—É–º–∞': 45000},
        
        # –õ–Æ–¢–ò–ô 2025
        {'–î–∞—Ç–∞': '2025-02-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ù–∞ —Ä–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 510000},
        {'–î–∞—Ç–∞': '2025-02-05', '–¢–∏–ø': '1. –ü–†–ò–•–û–î–ò', '–°—Ç–∞—Ç—Ç—è': '–ì–æ—Ç—ñ–≤–∫–∞', '–°—É–º–∞': 140000},
        {'–î–∞—Ç–∞': '2025-02-10', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞', '–°—É–º–∞': 50000},
        {'–î–∞—Ç–∞': '2025-02-15', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–¥—ñ—ó', '–°—É–º–∞': 165000},
        {'–î–∞—Ç–∞': '2025-02-20', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 92000},
        {'–î–∞—Ç–∞': '2025-02-25', '–¢–∏–ø': '2. –í–ò–¢–†–ê–¢–ò', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞/–º', '–°—É–º–∞': 30000}
    ]
    return pd.DataFrame(data)

# --- 2. –ü–Ü–î–ì–û–¢–û–í–ö–ê ---
st.title("üìä –ü–æ–≤–Ω–∏–π —É–ø—Ä–∞–≤–ª—ñ–Ω—Å—å–∫–∏–π –∑–≤—ñ—Ç P&L")
df = get_demo_data()
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df['–ú—ñ—Å—è—Ü—å'] = df['–î–∞—Ç–∞'].dt.strftime('%Y-%m')
df['–°—É–º–∞'] = pd.to_numeric(df['–°—É–º–∞'], errors='coerce').fillna(0)

# --- 3. –†–û–ó–ì–û–†–ù–£–¢–ê –¢–ê–ë–õ–ò–¶–Ø P&L (Pivot) ---
st.subheader("üìë –ó–≤—ñ—Ç –ø—Ä–æ –ø—Ä–∏–±—É—Ç–∫–∏ —Ç–∞ –∑–±–∏—Ç–∫–∏ (–ø–æ –º—ñ—Å—è—Ü—è—Ö)")

# –°—Ç–≤–æ—Ä—é—î–º–æ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç—É —Ç–∞–±–ª–∏—Ü—é, –¥–µ –¢–∏–ø —ñ –°—Ç–∞—Ç—Ç—è ‚Äî —Ü–µ —Ä—è–¥–∫–∏
pnl_pivot = df.pivot_table(
    index=['–¢–∏–ø', '–°—Ç–∞—Ç—Ç—è'], 
    columns='–ú—ñ—Å—è—Ü—å', 
    values='–°—É–º–∞', 
    aggfunc='sum', 
    fill_value=0
)

# –î–æ–¥–∞—î–º–æ –∫–æ–ª–æ–Ω–∫—É "–†–∞–∑–æ–º"
pnl_pivot['–†–ê–ó–û–ú'] = pnl_pivot.sum(axis=1)

# –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤–∏–≤–æ–¥—É
st.dataframe(
    pnl_pivot.style.format("{:,.0f}")
    .background_gradient(cmap='Greens', subset=pd.IndexSlice[('1. –ü–†–ò–•–û–î–ò', slice(None)), :])
    .background_gradient(cmap='Reds', subset=pd.IndexSlice[('2. –í–ò–¢–†–ê–¢–ò', slice(None)), :]),
    use_container_width=True, height=500
)

# --- 4. –†–û–ó–†–ê–•–£–ù–û–ö –§–Ü–ù–ê–ù–°–û–í–û–ì–û –†–ï–ó–£–õ–¨–¢–ê–¢–£ ---
st.divider()
st.subheader("üí∞ –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –ø—ñ–¥—Å—É–º–æ–∫")

income_by_month = df[df['–¢–∏–ø'] == '1. –ü–†–ò–•–û–î–ò'].groupby('–ú—ñ—Å—è—Ü—å')['–°—É–º–∞'].sum()
expense_by_month = df[df['–¢–∏–ø'] == '2. –í–ò–¢–†–ê–¢–ò'].groupby('–ú—ñ—Å—è—Ü—å')['–°—É–º–∞'].sum()
profit_by_month = income_by_month - expense_by_month

cols = st.columns(len(profit_by_month))
for i, (month, val) in enumerate(profit_by_month.items()):
    cols[i].metric(f"–ü—Ä–∏–±—É—Ç–æ–∫ {month}", f"{val:,.0f} PLN", 
                   delta=f"{(val/income_by_month[month]*100):.1f}% —Ä–µ–Ω—Ç–∞–±.")

# --- 5. –ì–†–ê–§–Ü–ö CASH FLOW ---
st.divider()
st.subheader("üìâ –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ª–∏—à–∫—É –Ω–∞ —Ä–∞—Ö—É–Ω–∫—É")
init_bal = 100000
df = df.sort_values('–î–∞—Ç–∞')
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if '–ü–†–ò–•–û–î–ò' in x['–¢–∏–ø'] else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

fig = go.Figure()
fig.add_trace(go.Scatter(x=df['–î–∞—Ç–∞'], y=df['–ó–∞–ª–∏—à–æ–∫'], mode='lines+markers', fill='tozeroy', name='–ë–∞–ª–∞–Ω—Å'))
fig.add_hline(y=0, line_dash="dash", line_color="red")
st.plotly_chart(fig, use_container_width=True)
