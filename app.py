import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Business Architect: P&L & CashFlow", layout="wide")

# --- 1. –ì–ï–ù–ï–†–ê–¶–Ü–Ø –î–ï–ú–û-–î–ê–ù–ò–• (2025 –†–Ü–ö) ---
def get_demo_data():
    data = [
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–û–ø–ª–∞—Ç–∞ –ö–ª—ñ—î–Ω—Ç –ê', '–°—É–º–∞': 250000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-15', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 60000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∏ –æ—Ñ—ñ—Å/—Å–∫–ª–∞–¥', '–°—É–º–∞': 120000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-02-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-03-01', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–§—ñ–Ω–∞–Ω—Å–∏', '–°—Ç–∞—Ç—Ç—è': '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫—Ä–µ–¥–∏—Ç—É', '–°—É–º–∞': 150000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-03-15', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–î–µ–±—ñ—Ç–æ—Ä–∫–∞ –ë', '–°—É–º–∞': 300000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'}
    ]
    return pd.DataFrame(data)

# --- 2. –Ü–ù–¢–ï–†–§–ï–ô–° ---
st.title("üíº Business Intelligence: P&L + Cash Flow")
st.sidebar.header("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É
demo_df = get_demo_data()
csv_template = demo_df.to_csv(index=False).encode('utf-8-sig')
st.sidebar.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω CSV", data=csv_template, file_name='finance_template_2025.csv', mime='text/csv')

uploaded_file = st.sidebar.file_uploader("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à —Ñ–∞–π–ª", type=['csv', 'xlsx'])
init_bal = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ (PLN)", value=80000)

if uploaded_file:
    try:
        df = pd.read_excel(uploaded_file) if uploaded_file.name.endswith('.xlsx') else pd.read_csv(uploaded_file)
        st.sidebar.success("–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!")
    except Exception as e:
        st.error(f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ —Ñ–∞–π–ª—É: {e}")
        df = demo_df
else:
    df = demo_df
    st.info("üí° –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –¥–µ–º–æ-–¥–∞–Ω—ñ. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤—ñ–π —Ñ–∞–π–ª —É –±—ñ—á–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ.")

# --- 3. –û–ë–†–û–ë–ö–ê –¢–ê –†–û–ó–†–ê–•–£–ù–ö–ò ---
# –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤ —Ç–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df = df.sort_values('–î–∞—Ç–∞')
# –û—á–∏—â–µ–Ω–Ω—è —Å—É–º–∏ (—è–∫—â–æ —Ä–∞–ø—Ç–æ–º —Ç–∞–º —Ç–µ–∫—Å—Ç –∞–±–æ –∫–æ–º–∏)
df['–°—É–º–∞'] = pd.to_numeric(df['–°—É–º–∞'], errors='coerce').fillna(0)

# –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ Cash Flow
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if x['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥' else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

# --- 4. –ë–õ–û–ö 1: P&L –ê–ù–ê–õ–Ü–¢–ò–ö–ê ---
st.subheader("üìà –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (P&L)")
total_inc = df[df['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥']['–°—É–º–∞'].sum()
total_exp = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞']['–°—É–º–∞'].sum()
net_profit = total_inc - total_exp
rent = (net_profit / total_inc * 100) if total_inc > 0 else 0

c1, c2, c3 = st.columns(3)
c1.metric("–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥", f"{total_inc:,.2f} PLN")
c2.metric("–ó–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏", f"{total_exp:,.2f} PLN", delta=f"-{total_exp:,.2f}", delta_color="inverse")
c3.metric("–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫", f"{net_profit:,.2f} PLN", delta=f"{rent:.1f}% –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å")

# –î—ñ–∞–≥—Ä–∞–º–∞ –≤–∏—Ç—Ä–∞—Ç
exp_df = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞'].groupby('–ù–∞–ø—Ä—è–º–æ–∫')['–°—É–º–∞'].sum().reset_index()
if not exp_df.empty:
    fig_pie = px.pie(exp_df, values='–°—É–º–∞', names='–ù–∞–ø—Ä—è–º–æ–∫', hole=0.4, title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç –ø–æ –Ω–∞–ø—Ä—è–º–∫–∞—Ö", color_discrete_sequence=px.colors.qualitative.Pastel)
    st.plotly_chart(fig_pie, use_container_width=True)

st.divider()

# --- 5. –ë–õ–û–ö 2: CASH FLOW –¢–ê –ü–†–û–ì–ù–û–ó –†–û–ó–†–ò–í–Ü–í ---
st.subheader("üìâ –ü—Ä–æ–≥–Ω–æ–∑ —Ä—É—Ö—É –≥—Ä–æ—à–æ–≤–∏—Ö –∫–æ—à—Ç—ñ–≤ (Cash Flow)")

fig_cf = go.Figure()
fig_cf.add_trace(go.Scatter(
    x=df['–î–∞—Ç–∞'], 
    y=df['–ó–∞–ª–∏—à–æ–∫'], 
    mode='lines+markers', 
    name='–ó–∞–ª–∏—à–æ–∫ –Ω–∞ —Ä–∞—Ö—É–Ω–∫—É', 
    line=dict(color='#00CC96', width=3),
    fill='tozeroy',
    fillcolor='rgba(0, 204, 150, 0.1)'
))

# –õ—ñ–Ω—ñ—è –Ω—É–ª—è —Ç–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –∑–æ–Ω–∞
fig_cf.add_hline(y=0, line_dash="dash", line_color="#FF4B4B")
fig_cf.add_hrect(y0=df['–ó–∞–ª–∏—à–æ–∫'].min() - 50000, y1=0, fillcolor="red", opacity=0.1, annotation_text="–ö–ê–°–û–í–ò–ô –†–û–ó–†–ò–í")

fig_cf.update_layout(xaxis_title="–î–∞—Ç–∞", yaxis_title="–ó–∞–ª–∏—à–æ–∫ (PLN)", hovermode="x unified")
st.plotly_chart(fig_cf, use_container_width=True)

# –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —Ä–∏–∑–∏–∫–∏
gaps = df[df['–ó–∞–ª–∏—à–æ–∫'] < 0]
if not gaps.empty:
    first_gap = gaps.iloc[0]['–î–∞—Ç–∞'].strftime('%d-%m-%Y')
    st.error(f"‚ö†Ô∏è **–£–í–ê–ì–ê:** –í–∏—è–≤–ª–µ–Ω–æ —Ä–∏–∑–∏–∫ –∫–∞—Å–æ–≤–æ–≥–æ —Ä–æ–∑—Ä–∏–≤—É {first_gap}! –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫: {gaps['–ó–∞–ª–∏—à–æ–∫'].min():,.2f} PLN.")
else:
    st.success("‚úÖ **–ì—Ä–æ—à–µ–π –¥–æ—Å—Ç–∞—Ç–Ω—å–æ:** –ó–≥—ñ–¥–Ω–æ –∑ –ø–ª–∞–Ω–æ–º, –∫–∞—Å–æ–≤–∏—Ö —Ä–æ–∑—Ä–∏–≤—ñ–≤ –Ω–µ –ø–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è.")

# –¢–∞–±–ª–∏—Ü—è
if st.checkbox("–ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π —Ä–µ—î—Å—Ç—Ä –æ–ø–µ—Ä–∞—Ü—ñ–π"):
    st.dataframe(df[['–î–∞—Ç–∞', '–¢–∏–ø', '–ù–∞–ø—Ä—è–º–æ–∫', '–°—Ç–∞—Ç—Ç—è', '–°—É–º–∞', '–°—Ç–∞—Ç—É—Å', '–ó–∞–ª–∏—à–æ–∫']].sort_values('–î–∞—Ç–∞'), use_container_width=True)
