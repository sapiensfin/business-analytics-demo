import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Business Architect: Deep Analytics", layout="wide")

# --- 1. –†–û–ó–®–ò–†–ï–ù–Ü –î–ï–ú–û-–î–ê–ù–Ü ---
def get_demo_data():
    data = [
        # –°—ñ—á–µ–Ω—å 2025
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–û–ø–ª–∞—Ç–∞ –ö–ª—ñ—î–Ω—Ç –ê', '–°—É–º–∞': 250000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-12', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 55000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-15', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞/–º', '–°—É–º–∞': 12000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥', '–°—É–º–∞': 80000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–¥—ñ—ó', '–°—É–º–∞': 90000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        
        # –õ—é—Ç–∏–π 2025
        {'–î–∞—Ç–∞': '2025-02-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–û–ø–ª–∞—Ç–∞ –ö–ª—ñ—î–Ω—Ç –ë', '–°—É–º–∞': 280000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-12', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 62000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-15', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞/–º', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥', '–°—É–º–∞': 80000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–¥—ñ—ó', '–°—É–º–∞': 95000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-25', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–ü–æ—Å–ª—É–≥–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—ó', '–°—É–º–∞': 5000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        
        # –ë–µ—Ä–µ–∑–µ–Ω—å 2025
        {'–î–∞—Ç–∞': '2025-03-01', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–§—ñ–Ω–∞–Ω—Å–∏', '–°—Ç–∞—Ç—Ç—è': '–ö—Ä–µ–¥–∏—Ç', '–°—É–º–∞': 100000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-03-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'}
    ]
    return pd.DataFrame(data)

# --- 2. –Ü–ù–¢–ï–†–§–ï–ô–° ---
st.title("üíº Business Intelligence: –ì–ª–∏–±–æ–∫–∏–π –∞–Ω–∞–ª—ñ–∑ –≤–∏—Ç—Ä–∞—Ç")
st.sidebar.header("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")

demo_df = get_demo_data()
csv_template = demo_df.to_csv(index=False).encode('utf-8-sig')
st.sidebar.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω CSV", data=csv_template, file_name='finance_analytics_2025.csv', mime='text/csv')

uploaded_file = st.sidebar.file_uploader("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à —Ñ–∞–π–ª", type=['csv', 'xlsx'])
init_bal = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ (PLN)", value=100000)

if uploaded_file:
    df = pd.read_excel(uploaded_file) if uploaded_file.name.endswith('.xlsx') else pd.read_csv(uploaded_file)
else:
    df = demo_df

# --- 3. –ü–Ü–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ò–• ---
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df['–ú—ñ—Å—è—Ü—å'] = df['–î–∞—Ç–∞'].dt.strftime('%Y-%m') # –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–ª–æ–Ω–∫—É –ú—ñ—Å—è—Ü—å –¥–ª—è –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è
df['–°—É–º–∞'] = pd.to_numeric(df['–°—É–º–∞'], errors='coerce').fillna(0)
df = df.sort_values('–î–∞—Ç–∞')

# –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ Cash Flow
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if x['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥' else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

# --- 4. DASHBOARD (–ú–ï–¢–†–ò–ö–ò) ---
total_inc = df[df['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥']['–°—É–º–∞'].sum()
total_exp = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞']['–°—É–º–∞'].sum()
net_profit = total_inc - total_exp

c1, c2, c3 = st.columns(3)
c1.metric("–í–∏—Ä—É—á–∫–∞ (–∑–∞ –≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥)", f"{total_inc:,.0f} PLN")
c2.metric("–í–∏—Ç—Ä–∞—Ç–∏ (–∑–∞ –≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥)", f"{total_exp:,.0f} PLN", delta_color="inverse")
c3.metric("–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫", f"{net_profit:,.0f} PLN")

st.divider()

# --- 5. –¢–ê–ë–õ–ò–¶–Ø –í–ò–¢–†–ê–¢ –ü–û –°–¢–ê–¢–¢–Ø–ú (PIVOT TABLE) ---
st.subheader("üìä –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç –ø–æ —Å—Ç–∞—Ç—Ç—è–º —Ç–∞ –º—ñ—Å—è—Ü—è–º")

# –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ª–∏—à–µ –≤–∏—Ç—Ä–∞—Ç–∏
expenses_only = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞'].copy()

if not expenses_only.empty:
    # –°—Ç–≤–æ—Ä—é—î–º–æ –∑–≤–µ–¥–µ–Ω—É —Ç–∞–±–ª–∏—Ü—é: –†—è–¥–∫–∏ - –°—Ç–∞—Ç—Ç—è, –°—Ç–æ–≤–ø—Ü—ñ - –ú—ñ—Å—è—Ü—å, –ó–Ω–∞—á–µ–Ω–Ω—è - –°—É–º–∞
    pivot_table = expenses_only.pivot_table(
        index='–°—Ç–∞—Ç—Ç—è', 
        columns='–ú—ñ—Å—è—Ü—å', 
        values='–°—É–º–∞', 
        aggfunc='sum', 
        fill_value=0
    )
    
    # –î–æ–¥–∞—î–º–æ –∫–æ–ª–æ–Ω–∫—É "–í—Å—å–æ–≥–æ"
    pivot_table['–í–°–¨–û–ì–û'] = pivot_table.sum(axis=1)
    pivot_table = pivot_table.sort_values(by='–í–°–¨–û–ì–û', ascending=False)
    
    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑ –ø—ñ–¥—Å–≤—ñ—Ç–∫–æ—é
    st.dataframe(pivot_table.style.format("{:,.0f}").background_gradient(cmap='Reds', axis=0), use_container_width=True)
else:
    st.warning("–î–∞–Ω—ñ –ø—Ä–æ –≤–∏—Ç—Ä–∞—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.")

st.divider()

# --- 6. –ì–†–ê–§–Ü–ö CASH FLOW ---
st.subheader("üìâ –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ª–∏—à–∫—É –Ω–∞ —Ä–∞—Ö—É–Ω–∫—É")
fig_cf = go.Figure()
fig_cf.add_trace(go.Scatter(x=df['–î–∞—Ç–∞'], y=df['–ó–∞–ª–∏—à–æ–∫'], mode='lines+markers', name='–ó–∞–ª–∏—à–æ–∫', line=dict(color='#00CC96', width=3)))
fig_cf.add_hline(y=0, line_dash="dash", line_color="red")
st.plotly_chart(fig_cf, use_container_width=True)
