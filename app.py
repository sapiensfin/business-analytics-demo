import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="Business Architect: Global Dashboard", layout="wide")

# --- 1. –ü–û–í–ù–Ü –î–ï–ú–û-–î–ê–ù–Ü (–í–ö–õ–Æ–ß–ê–Æ–ß–ò –í–°–Ü –°–¢–ê–¢–¢–Ü) ---
def get_demo_data():
    data = [
        # –°–Ü–ß–ï–ù–¨ 2025
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–î–æ—Ö—ñ–¥: –†–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 450000},
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–î–∂–µ—Ä–µ–ª–æ': '–ì–æ—Ç—ñ–≤–∫–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–î–æ—Ö—ñ–¥: –ì–æ—Ç—ñ–≤–∫–∞', '–°—É–º–∞': 120000},
        {'–î–∞—Ç–∞': '2025-01-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞', '–°—É–º–∞': 50000},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –æ—Ñ—ñ—Å', '–°—É–º–∞': 60000},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥', '–°—É–º–∞': 90000},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–¥—ñ—ó', '–°—É–º–∞': 150000},
        {'–î–∞—Ç–∞': '2025-01-22', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–ü–ú–ú', '–°—É–º–∞': 85000},
        {'–î–∞—Ç–∞': '2025-01-25', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–æ–¥–∞—Ç–∫–∏', '–°—Ç–∞—Ç—Ç—è': '–ü–æ–¥–∞—Ç–∫–∏ –Ω–∞ –∑/–ø', '–°—É–º–∞': 45000},
        {'–î–∞—Ç–∞': '2025-01-26', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–ì–æ—Ç—ñ–≤–∫–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞/–º', '–°—É–º–∞': 15000},
        {'–î–∞—Ç–∞': '2025-01-30', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ê–¥–º—ñ–Ω', '–°—Ç–∞—Ç—Ç—è': '–ö–æ–º—É–Ω–∞–ª—å–Ω—ñ –ø–æ—Å–ª—É–≥–∏', '–°—É–º–∞': 8000},

        # –õ–Æ–¢–ò–ô 2025 (–ü–ª–∞–Ω)
        {'–î–∞—Ç–∞': '2025-02-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–î–æ—Ö—ñ–¥: –†–∞—Ö—É–Ω–æ–∫', '–°—É–º–∞': 480000},
        {'–î–∞—Ç–∞': '2025-02-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–†–∞—Ö—É–Ω–æ–∫', '–ù–∞–ø—Ä—è–º–æ–∫': '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤–æ–¥—ñ—ó', '–°—É–º–∞': 160000},
        {'–î–∞—Ç–∞': '2025-02-28', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ': '–ì–æ—Ç—ñ–≤–∫–∞', '–ù–∞–ø—Ä—è–º–æ–∫': '–õ–æ–≥—ñ—Å—Ç–∏–∫–∞', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞/–º', '–°—É–º–∞': 40000},
    ]
    return pd.DataFrame(data)

# --- 2. –Ü–ù–¢–ï–†–§–ï–ô–° –¢–ê –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ---
st.title("üèÜ Financial Navigator: Global Business Report")
st.sidebar.header("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")

df_demo = get_demo_data()
uploaded_file = st.sidebar.file_uploader("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à CSV", type=['csv'])
init_bal = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ (PLN)", value=100000)

if uploaded_file:
    df = pd.read_csv(uploaded_file)
else:
    df = df_demo
    st.info("üí° –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –¥–µ–º–æ-–¥–∞–Ω—ñ. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤—ñ–π —Ñ–∞–π–ª —É –±—ñ—á–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ.")

# --- 3. –û–ë–†–û–ë–ö–ê –î–ê–ù–ò–• ---
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df['–ú—ñ—Å—è—Ü—å'] = df['–î–∞—Ç–∞'].dt.strftime('%Y-%m')
df['–°—É–º–∞'] = pd.to_numeric(df['–°—É–º–∞'], errors='coerce').fillna(0)
df = df.sort_values('–î–∞—Ç–∞')

# --- 4. –ú–ï–¢–†–ò–ö–ò (P&L Summary) ---
st.subheader("üìå –ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ (P&L Summary)")
total_inc = df[df['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥']['–°—É–º–∞'].sum()
total_exp = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞']['–°—É–º–∞'].sum()
net_profit = total_inc - total_exp
margin = (net_profit / total_inc * 100) if total_inc > 0 else 0

m1, m2, m3 = st.columns(3)
m1.metric("–ó–∞–≥–∞–ª—å–Ω–∞ –í–∏—Ä—É—á–∫–∞", f"{total_inc:,.0f} PLN")
m2.metric("–ó–∞–≥–∞–ª—å–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏", f"{total_exp:,.0f} PLN", delta_color="inverse")
m3.metric("–ß–∏—Å—Ç–∏–π –ü—Ä–∏–±—É—Ç–æ–∫", f"{net_profit:,.0f} PLN", delta=f"{margin:.1f}% –ú–∞—Ä–∂–∞")

st.divider()

# --- 5. –ì–õ–ò–ë–û–ö–ò–ô –ê–ù–ê–õ–Ü–ó –í–ò–¢–†–ê–¢ (Pivot Table) ---
st.subheader("üìä –ì–ª–∏–±–æ–∫–∏–π –∞–Ω–∞–ª—ñ–∑ –≤–∏—Ç—Ä–∞—Ç –ø–æ —Å—Ç–∞—Ç—Ç—è–º")
expenses_only = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞'].copy()

if not expenses_only.empty:
    # –¢–£–¢ –í–ò–ü–†–ê–í–õ–ï–ù–û –ù–ê–ó–í–£ –ö–û–õ–û–ù–ö–ò '–°—É–º–∞'
    pivot_exp = expenses_only.pivot_table(index='–°—Ç–∞—Ç—Ç—è', columns='–ú—ñ—Å—è—Ü—å', values='–°—É–º–∞', aggfunc='sum', fill_value=0)
    pivot_exp['–í–°–¨–û–ì–û'] = pivot_exp.sum(axis=1)
    pivot_exp = pivot_exp.sort_values('–í–°–¨–û–ì–û', ascending=False)
    
    st.dataframe(pivot_exp.style.format("{:,.0f}").background_gradient(cmap='Reds', axis=0), use_container_width=True)
else:
    st.warning("–î–∞–Ω—ñ –ø—Ä–æ –≤–∏—Ç—Ä–∞—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.")

st.divider()

# --- 6. –ü–†–û–ì–ù–û–ó CASH FLOW ---
st.subheader("üìâ –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ª–∏—à–∫—É –Ω–∞ —Ä–∞—Ö—É–Ω–∫—É (Cash Flow)")
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if x['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥' else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = init_bal + df['–ó–º—ñ–Ω–∞'].cumsum()

fig_cf = go.Figure()
fig_cf.add_trace(go.Scatter(x=df['–î–∞—Ç–∞'], y=df['–ó–∞–ª–∏—à–æ–∫'], mode='lines+markers', name='–ó–∞–ª–∏—à–æ–∫ –≥—Ä–æ—à–µ–π', fill='tozeroy', line=dict(color='#00CC96')))
fig_cf.add_hline(y=0, line_dash="dash", line_color="red", annotation_text="–ö–ê–°–û–í–ò–ô –†–û–ó–†–ò–í")
fig_cf.update_layout(xaxis_title="–î–∞—Ç–∞", yaxis_title="PLN")
st.plotly_chart(fig_cf, use_container_width=True)

# –ö–Ω–æ–ø–∫–∞ —à–∞–±–ª–æ–Ω—É
csv_data = df_demo[['–î–∞—Ç–∞', '–¢–∏–ø', '–î–∂–µ—Ä–µ–ª–æ', '–ù–∞–ø—Ä—è–º–æ–∫', '–°—Ç–∞—Ç—Ç—è', '–°—É–º–∞']].to_csv(index=False).encode('utf-8-sig')
st.sidebar.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω", data=csv_data, file_name='business_template_2025.csv')
