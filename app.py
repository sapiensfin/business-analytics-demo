import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta

st.set_page_config(page_title="Financial Navigator 2025", layout="wide")

# --- –ì–ï–ù–ï–†–ê–¶–Ü–Ø –ó–†–ê–ó–ö–ê –§–ê–ô–õ–£ (2025 –†–Ü–ö) ---
def generate_sample_data():
    # –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π –¥–ª—è —ñ–ª—é—Å—Ç—Ä–∞—Ü—ñ—ó 2025 —Ä–æ–∫—É
    data = [
        # –§–∞–∫—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ (–°—ñ—á–µ–Ω—å 2025)
        {'–î–∞—Ç–∞': '2025-01-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–°—Ç–∞—Ç—Ç—è': '–û–ø–ª–∞—Ç–∞ –∑–∞ –ª–æ–≥—ñ—Å—Ç–∏–∫—É (–ö–ª—ñ—î–Ω—Ç A)', '–°—É–º–∞': 220000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É (–í–∞—Ä—à–∞–≤–∞)', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        {'–î–∞—Ç–∞': '2025-01-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∏ —Ç–∞ –ø–æ–¥–∞—Ç–∫–∏ (ZUS)', '–°—É–º–∞': 110000, '–°—Ç–∞—Ç—É—Å': '–§–∞–∫—Ç'},
        
        # –ü–ª–∞–Ω–æ–≤—ñ –¥–∞–Ω—ñ (–õ—é—Ç–∏–π - –ë–µ—Ä–µ–∑–µ–Ω—å 2025)
        {'–î–∞—Ç–∞': '2025-02-05', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–°—Ç–∞—Ç—Ç—è': '–ö–æ–Ω—Ç—Ä–∞–∫—Ç ‚Ññ44 (–î–µ–±—ñ—Ç–æ—Ä–∫–∞)', '–°—É–º–∞': 180000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-10', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–û—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥—É', '–°—É–º–∞': 45000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-15', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–ó–∞–∫—É–ø—ñ–≤–ª—è –ø–∞–ª–∏–≤–∞ (–ü–ú–ú)', '–°—É–º–∞': 65000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-20', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–ó–∞—Ä–ø–ª–∞—Ç–∏ (–ü—Ä–æ–≥–Ω–æ–∑)', '–°—É–º–∞': 115000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-02-28', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–†–µ–º–æ–Ω—Ç –∞–≤—Ç–æ–ø–∞—Ä–∫—É', '–°—É–º–∞': 40000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        
        # –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π —Ä–æ–∑—Ä–∏–≤ —É –±–µ—Ä–µ–∑–Ω—ñ
        {'–î–∞—Ç–∞': '2025-03-05', '–¢–∏–ø': '–í–∏—Ç—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—Ç—è': '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫—Ä–µ–¥–∏—Ç—É', '–°—É–º–∞': 90000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
        {'–î–∞—Ç–∞': '2025-03-15', '–¢–∏–ø': '–ü—Ä–∏—Ö—ñ–¥', '–°—Ç–∞—Ç—Ç—è': '–í–µ–ª–∏–∫–∏–π —Ç–µ–Ω–¥–µ—Ä (–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è)', '–°—É–º–∞': 350000, '–°—Ç–∞—Ç—É—Å': '–ü–ª–∞–Ω'},
    ]
    return pd.DataFrame(data)

# --- –Ü–ù–¢–ï–†–§–ï–ô–° ---
st.sidebar.title("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")
st.title("üìä Financial Navigator 2025")
st.markdown("### –ü—Ä–æ–≥–Ω–æ–∑ –ª—ñ–∫–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Ç–∞ –∞–Ω–∞–ª—ñ–∑ –∫–∞—Å–æ–≤–∏—Ö —Ä–æ–∑—Ä–∏–≤—ñ–≤")

# –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É
sample_df = generate_sample_data()
csv_sample = sample_df.to_csv(index=False).encode('utf-8-sig')

st.sidebar.download_button(
    label="üì• –°–∫–∞—á–∞—Ç–∏ –∑—Ä–∞–∑–æ–∫ —Ñ–∞–π–ª—É 2025",
    data=csv_sample,
    file_name='finance_template_2025.csv',
    mime='text/csv'
)

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
uploaded_file = st.sidebar.file_uploader("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π —Ñ–∞–π–ª", type=['csv', 'xlsx'])
initial_balance = st.sidebar.number_input("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫ –Ω–∞ —Ä–∞—Ö—É–Ω–∫—É (PLN)", value=70000)

if uploaded_file:
    df = pd.read_excel(uploaded_file) if uploaded_file.name.endswith('.xlsx') else pd.read_csv(uploaded_file)
    st.sidebar.success("–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!")
else:
    df = sample_df
    st.info("üí° –ó–∞—Ä–∞–∑ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è **—ñ–ª—é—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –¥–∞–Ω—ñ –Ω–∞ 2025 —Ä—ñ–∫**. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤—ñ–π —Ñ–∞–π–ª —É –±—ñ—á–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ.")

# –û–±—Ä–æ–±–∫–∞ –¥–∞—Ç
df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
df = df.sort_values('–î–∞—Ç–∞')

# –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ Cash Flow
df['–ó–º—ñ–Ω–∞'] = df.apply(lambda x: x['–°—É–º–∞'] if x['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥' else -x['–°—É–º–∞'], axis=1)
df['–ó–∞–ª–∏—à–æ–∫'] = initial_balance + df['–ó–º—ñ–Ω–∞'].cumsum()

# --- –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø ---
# 1. –ì—Ä–∞—Ñ—ñ–∫ –∑–∞–ª–∏—à–∫—É –≥—Ä–æ—à–µ–π
fig_cf = go.Figure()
fig_cf.add_trace(go.Scatter(
    x=df['–î–∞—Ç–∞'], y=df['–ó–∞–ª–∏—à–æ–∫'], 
    mode='lines+markers+text',
    name='–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ª–∏—à–∫—É',
    line=dict(color='#00FFAA', width=3),
    fill='tozeroy',
    fillcolor='rgba(0, 255, 170, 0.1)'
))

# –õ—ñ–Ω—ñ—è –Ω—É–ª—è (–∫—Ä–∏—Ç–∏—á–Ω–∞ –º–µ–∂–∞)
fig_cf.add_hline(y=0, line_dash="dash", line_color="#FF4B4B", line_width=2)
fig_cf.add_hrect(y0=-1000000, y1=0, fillcolor="red", opacity=0.1, annotation_text="–ó–û–ù–ê –ö–ê–°–û–í–û–ì–û –†–û–ó–†–ò–í–£")

fig_cf.update_layout(title="–ü—Ä–æ–≥–Ω–æ–∑ —Ä—É—Ö—É –≥—Ä–æ—à–æ–≤–∏—Ö –∫–æ—à—Ç—ñ–≤ (Cash Flow 2025)", height=500)
st.plotly_chart(fig_cf, use_container_width=True)

# 2. –ê–Ω–∞–ª—ñ–∑ —Ä–æ–∑—Ä–∏–≤—ñ–≤
danger_zone = df[df['–ó–∞–ª–∏—à–æ–∫'] < 0]
col1, col2 = st.columns(2)

with col1:
    if not danger_zone.empty:
        st.error(f"üî¥ –í–∏—è–≤–ª–µ–Ω–æ —Ä–∏–∑–∏–∫ –∫–∞—Å–æ–≤–æ–≥–æ —Ä–æ–∑—Ä–∏–≤—É: {danger_zone.iloc[0]['–î–∞—Ç–∞'].strftime('%d-%m-%Y')}")
        st.write(f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –¥–µ—Ñ—ñ—Ü–∏—Ç: **{danger_zone['–ó–∞–ª–∏—à–æ–∫'].min():,.0f} PLN**")
    else:
        st.success("üü¢ –ö–∞—Å–æ–≤–∏—Ö —Ä–æ–∑—Ä–∏–≤—ñ–≤ —É –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–æ–º—É –ø–µ—Ä—ñ–æ–¥—ñ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ")

with col2:
    total_income = df[df['–¢–∏–ø'] == '–ü—Ä–∏—Ö—ñ–¥']['–°—É–º–∞'].sum()
    total_expenses = df[df['–¢–∏–ø'] == '–í–∏—Ç—Ä–∞—Ç–∞']['–°—Éma'].sum()
    st.metric("–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (Net)", f"{total_income - total_expenses:,.0f} PLN")

# 3. –î–µ—Ç–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è
st.subheader("üìù –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–ª–∞—Ç–µ–∂—ñ–≤ 2025")
st.dataframe(df[['–î–∞—Ç–∞', '–¢–∏–ø', '–°—Ç–∞—Ç—Ç—è', '–°—É–º–∞', '–°—Ç–∞—Ç—É—Å', '–ó–∞–ª–∏—à–æ–∫']].sort_values('–î–∞—Ç–∞'), use_container_width=True)
